<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Instituciones</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, serverTimestamp, doc, getDoc, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        window.firebase = { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, collection, addDoc, onSnapshot, query, serverTimestamp, doc, getDoc, deleteDoc, getDocs };
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        :root {
            --fondoClaro: #f4f7f9;
            --primarioFuerte: #2d5a81;
            --secundarioCalido: #e8e4d3;
            --acento: #4fc3c4;
            --textoOscuro: #333d45;
            --sombra: #d8e2ea;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--fondoClaro);
        }
        .container {
            max-width: 900px;
        }

        /* Custom styles for the responsive menu */
        .nav-menu {
            transition: transform 0.3s ease-in-out;
        }
        .nav-backdrop {
            transition: opacity 0.3s ease-in-out;
        }
        .nav-menu.hidden {
            transform: translateX(100%);
        }
        .nav-backdrop.hidden {
            opacity: 0;
            pointer-events: none;
        }
    </style>
</head>
<body class="p-0">
    <!-- Header Section -->
    <header class="sticky top-0 z-50 flex items-center justify-between p-4 shadow-lg" style="background-color: var(--primarioFuerte);">
        <h1 class="text-xl font-bold text-white">HIGA - Servicio de Farmacia</h1>
        <a href="index.html" class="px-4 py-2 text-white transition duration-200 rounded-md hover:bg-gray-700">Volver a la app</a>
    </header>

    <!-- Main Application Container -->
    <div class="p-8">
        <div class="container mx-auto p-8 rounded-xl shadow-lg border mb-8" style="background-color: var(--secundarioCalido); border-color: var(--sombra);">
            <h1 class="text-3xl font-bold text-center mb-6" style="color: var(--primarioFuerte);">Gestor de Instituciones (Administración)</h1>
            <div id="user-info" class="text-center text-sm mb-4" style="color: var(--textoOscuro);">
                <p>Tu ID de Usuario: <span id="user-id" class="font-bold">Cargando...</span></p>
            </div>

            <div id="admin-panel" class="hidden">
                <div class="flex items-center space-x-4 mb-4">
                    <input id="new-institucion" type="text" placeholder="Nueva institución" class="flex-grow rounded-md shadow-sm p-3 border-2 transition duration-200" style="background-color: var(--fondoClaro); border-color: var(--sombra); color: var(--textoOscuro);">
                    <button onclick="addInstitution()" class="text-white font-semibold py-3 px-4 rounded-md hover:bg-opacity-80 transition duration-200 shadow-lg" style="background-color: var(--acento);">
                        Agregar
                    </button>
                </div>
                <div id="instituciones-list" class="space-y-2">
                    <p class="text-center" style="color: var(--textoOscuro);">Cargando instituciones...</p>
                </div>
            </div>
            <div id="denied-message" class="hidden text-center text-red-600 font-bold text-lg">
                <p>Acceso Denegado. No tienes permisos de administrador.</p>
                <p class="mt-2 text-sm text-gray-700">Para obtener acceso, por favor, agrega tu ID de usuario (`<span id="denied-user-id"></span>`) a la colección 'admins' en tu base de datos de Firestore.</p>
            </div>
        </div>
    </div>
    <!-- Custom Alert Modal -->
    <div id="custom-alert-container"></div>
    
    <script>
        // Global variables for Firebase
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        let db, auth, userId;

        document.addEventListener('DOMContentLoaded', (event) => {
            // Initialize Firebase and set up auth listener
            if (Object.keys(firebaseConfig).length > 0) {
                const firebaseApp = window.firebase.initializeApp(firebaseConfig);
                db = window.firebase.getFirestore(firebaseApp);
                auth = window.firebase.getAuth(firebaseApp);

                window.firebase.onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('user-id').textContent = userId;
                        document.getElementById('denied-user-id').textContent = userId;
                        checkAdminStatus(userId);
                    } else {
                        try {
                            const initialToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                            if (initialToken) {
                                await window.firebase.signInWithCustomToken(auth, initialToken);
                            } else {
                                const anonymousUser = await window.firebase.signInAnonymously(auth);
                                userId = anonymousUser.user.uid;
                                document.getElementById('user-id').textContent = userId;
                                document.getElementById('denied-user-id').textContent = userId;
                                checkAdminStatus(userId);
                            }
                        } catch (error) {
                            console.error("Error during authentication:", error);
                            showCustomAlert(`Error de autenticación: ${error.message}`);
                        }
                    }
                });
            } else {
                showCustomAlert("Configuración de Firebase no encontrada. La funcionalidad de la base de datos no estará disponible.");
                document.getElementById('user-id').textContent = "No disponible";
                document.getElementById('denied-message').classList.remove('hidden');
                document.getElementById('admin-panel').classList.add('hidden');
            }
        });
        
        async function checkAdminStatus(uid) {
            const adminDocRef = window.firebase.doc(db, `/artifacts/${appId}/public/data/admins`, uid);
            const adminDoc = await window.firebase.getDoc(adminDocRef);

            if (adminDoc.exists()) {
                document.getElementById('admin-panel').classList.remove('hidden');
                document.getElementById('denied-message').classList.add('hidden');
                setupRealtimeListeners();
            } else {
                document.getElementById('admin-panel').classList.add('hidden');
                document.getElementById('denied-message').classList.remove('hidden');
            }
        }

        function setupRealtimeListeners() {
            // Listen for changes to institutions
            const institucionesCollectionPath = `/artifacts/${appId}/public/data/instituciones`;
            const institucionesQuery = window.firebase.query(window.firebase.collection(db, institucionesCollectionPath));
            
            window.firebase.onSnapshot(institucionesQuery, async (snapshot) => {
                const institucionesList = document.getElementById('instituciones-list');
                
                // Clear existing list
                institucionesList.innerHTML = '';

                if (snapshot.empty) {
                    await addInitialInstitutions();
                    institucionesList.innerHTML = `<p class="text-center text-sm font-semibold" style="color: var(--textoOscuro);">No hay instituciones guardadas.</p>`;
                } else {
                    snapshot.forEach((doc) => {
                        const institucion = doc.data();
                        
                        // Populate the management list
                        const listElement = document.createElement('div');
                        listElement.className = 'bg-white p-2 rounded-md shadow flex justify-between items-center';
                        listElement.style.borderColor = 'var(--sombra)';
                        listElement.innerHTML = `
                            <p class="text-sm font-semibold" style="color: var(--textoOscuro);">${institucion.name}</p>
                            <button onclick="deleteInstitution('${doc.id}')" class="text-xs font-semibold px-2 py-1 rounded-md transition duration-200" style="background-color: var(--primarioFuerte); color: white;">Eliminar</button>
                        `;
                        institucionesList.appendChild(listElement);
                    });
                }
            }, (error) => {
                console.error("Error listening to institutions:", error);
                showCustomAlert(`Error al cargar las instituciones: ${error.message}`);
            });
        }
        
        async function addInitialInstitutions() {
            const initialInstitutions = ["HPC", "Houssay", "HIEMI"];
            const institutionsCollection = window.firebase.collection(db, `/artifacts/${appId}/public/data/instituciones`);
            for (const name of initialInstitutions) {
                await window.firebase.addDoc(institutionsCollection, { name });
            }
        }

        async function addInstitution() {
            const newInstitucionInput = document.getElementById('new-institucion');
            const name = newInstitucionInput.value.trim();

            if (name === "") {
                showCustomAlert("El nombre de la institución no puede estar vacío.");
                return;
            }

            try {
                const institutionsCollection = window.firebase.collection(db, `/artifacts/${appId}/public/data/instituciones`);
                await window.firebase.addDoc(institutionsCollection, { name });
                newInstitucionInput.value = '';
            } catch (error) {
                console.error("Error adding institution:", error);
                showCustomAlert(`Error al agregar la institución: ${error.message}`);
            }
        }

        async function deleteInstitution(docId) {
            try {
                const docRef = window.firebase.doc(db, `/artifacts/${appId}/public/data/instituciones`, docId);
                await window.firebase.deleteDoc(docRef);
            } catch (error) {
                console.error("Error deleting institution:", error);
                showCustomAlert(`Error al eliminar la institución: ${error.message}`);
            }
        }

        function showCustomAlert(message) {
            const container = document.getElementById('custom-alert-container');
            container.innerHTML = `
                <div class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white p-6 rounded-lg shadow-lg max-w-sm w-full text-center">
                        <p class="text-gray-700 text-lg font-semibold mb-4 whitespace-pre-wrap">${message}</p>
                        <button onclick="document.getElementById('custom-alert-container').innerHTML = ''" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 transition-colors">Aceptar</button>
                    </div>
                </div>
            `;
        }
    </script>
</body>
</html>
