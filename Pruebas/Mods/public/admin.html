<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Administradores e Instituciones</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        window.firebase = { initializeApp, getAuth, signOut, onAuthStateChanged, getFirestore, doc, setDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, getDoc };
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        :root {
            --fondoClaro: #f4f7f9;
            --primarioFuerte: #2d5a81;
            --secundarioCalido: #e8e4d3;
            --acento: #4fc3c4;
            --textoOscuro: #333d45;
            --sombra: #d8e2ea;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--fondoClaro);
        }
        .container {
            max-width: 900px;
        }
        .tab-button {
            transition: color 0.2s, border-bottom-color 0.2s;
        }
    </style>
</head>
<body class="p-8">
    
    <!-- Custom Alert Modal -->
    <div id="custom-alert-container"></div>

    <div id="main-content" class="container mx-auto p-8 rounded-xl shadow-lg border" style="background-color: var(--secundarioCalido); border-color: var(--sombra);">
        <h1 class="text-3xl font-bold text-center mb-6" style="color: var(--primarioFuerte);">Gestor de la Aplicación</h1>
        <div id="loading" class="text-center font-semibold text-gray-700" style="color: var(--textoOscuro);">Cargando...</div>
        
        <div id="admin-panel" class="hidden">
            <p id="user-info" class="text-center text-sm mb-4" style="color: var(--textoOscuro);">Tu ID de Usuario: <span id="user-id" class="font-bold">Cargando...</span></p>

            <!-- Tab Buttons -->
            <div class="flex border-b border-gray-400 mb-6">
                <button id="tab-admins" class="flex-1 p-3 font-semibold text-center border-b-2 tab-button" style="color: var(--primarioFuerte); border-color: var(--primarioFuerte);">
                    Administradores
                </button>
                <button id="tab-institutions" class="flex-1 p-3 font-semibold text-center text-gray-600 border-b-2 border-transparent hover:border-gray-400 tab-button" style="color: var(--textoOscuro);">
                    Instituciones
                </button>
            </div>

            <!-- Content for Admin Tab -->
            <div id="content-admins" class="space-y-6">
                <!-- Add Admin Section -->
                <div class="p-6 rounded-lg shadow-inner" style="background-color: var(--fondoClaro); border: 2px solid var(--sombra);">
                    <h2 class="text-xl font-semibold mb-4" style="color: var(--primarioFuerte);">Agregar Administrador</h2>
                    <p class="text-sm mb-4" style="color: var(--textoOscuro);">Ingresa la ID de usuario para otorgarle permisos de administrador.</p>
                    <div class="flex flex-col sm:flex-row gap-4">
                        <input type="text" id="add-admin-id" placeholder="ID de Usuario" class="flex-grow rounded-md shadow-sm p-3 border-2 transition duration-200" style="background-color: var(--secundarioCalido); border-color: var(--sombra); color: var(--textoOscuro);">
                        <button id="add-admin-btn" class="text-white font-bold py-3 px-6 rounded-md hover:bg-opacity-80 transition duration-200 shadow-lg" style="background-color: var(--primarioFuerte);">
                            Agregar
                        </button>
                    </div>
                </div>

                <!-- Admin List Section -->
                <div class="p-6 rounded-lg shadow-inner" style="background-color: var(--fondoClaro); border: 2px solid var(--sombra);">
                    <h2 class="text-xl font-semibold mb-4" style="color: var(--primarioFuerte);">Administradores Actuales</h2>
                    <ul id="admins-list" class="space-y-2">
                        <!-- Admin IDs will be displayed here -->
                    </ul>
                </div>
            </div>

            <!-- Content for Institutions Tab -->
            <div id="content-institutions" class="space-y-6 hidden">
                <!-- Add Institution Section -->
                <div class="p-6 rounded-lg shadow-inner" style="background-color: var(--fondoClaro); border: 2px solid var(--sombra);">
                    <h2 class="text-xl font-semibold mb-4" style="color: var(--primarioFuerte);">Agregar Institución</h2>
                    <p class="text-sm mb-4" style="color: var(--textoOscuro);">Ingresa el nombre de la institución para que aparezca en el menú principal.</p>
                    <div class="flex flex-col sm:flex-row gap-4">
                        <input type="text" id="add-institution-name" placeholder="Nombre de la Institución" class="flex-grow rounded-md shadow-sm p-3 border-2 transition duration-200" style="background-color: var(--secundarioCalido); border-color: var(--sombra); color: var(--textoOscuro);">
                        <button id="add-institution-btn" class="text-white font-bold py-3 px-6 rounded-md hover:bg-opacity-80 transition duration-200 shadow-lg" style="background-color: var(--acento);">
                            Agregar
                        </button>
                    </div>
                </div>
                
                <!-- Institution List Section -->
                <div class="p-6 rounded-lg shadow-inner" style="background-color: var(--fondoClaro); border: 2px solid var(--sombra);">
                    <h2 class="text-xl font-semibold mb-4" style="color: var(--primarioFuerte);">Instituciones Actuales</h2>
                    <ul id="institutions-list" class="space-y-2">
                        <!-- Institution names will be displayed here -->
                    </ul>
                </div>
            </div>

            <!-- Back and Logout Buttons -->
            <div class="mt-8 flex justify-between">
                <a href="index.html" class="inline-block text-white font-bold py-3 px-6 rounded-md hover:bg-opacity-80 transition duration-200 shadow-lg" style="background-color: var(--acento);">
                    ← Volver
                </a>
                <button id="logout-button" class="text-white font-bold py-3 px-6 rounded-md hover:bg-red-700 transition duration-200 shadow-lg" style="background-color: #d9534f;">
                    Cerrar sesión
                </button>
            </div>
        </div>
        
        <!-- Not Authorized Panel -->
        <div id="not-authorized" class="hidden text-center p-8 rounded-lg shadow-lg" style="background-color: var(--secundarioCalido);">
            <h2 class="text-2xl font-bold mb-4" style="color: var(--primarioFuerte);">Acceso Denegado</h2>
            <p class="text-lg" style="color: var(--textoOscuro);">No tienes permisos para acceder a esta página.</p>
            <a href="index.html" class="mt-6 inline-block text-white font-bold py-3 px-6 rounded-md hover:bg-opacity-80 transition duration-200 shadow-lg" style="background-color: var(--acento);">
                ← Volver al Inicio
            </a>
        </div>
    </div>
    
    <script>

        const firebaseConfig = {

        };
        const appId = firebaseConfig.projectId;

        let db, auth, userId;
        
        document.addEventListener('DOMContentLoaded', async () => {
            const loadingPanel = document.getElementById('loading');
            const adminPanel = document.getElementById('admin-panel');
            const notAuthorizedPanel = document.getElementById('not-authorized');
            
            if (!firebaseConfig.apiKey) {
                loadingPanel.classList.add('hidden');
                notAuthorizedPanel.classList.remove('hidden');
                showCustomAlert("Configuración de Firebase no encontrada. Acceso denegado.");
                return;
            }

            const firebaseApp = window.firebase.initializeApp(firebaseConfig);
            db = window.firebase.getFirestore(firebaseApp);
            auth = window.firebase.getAuth(firebaseApp);

            window.firebase.onAuthStateChanged(auth, async (user) => {
                loadingPanel.classList.add('hidden');
                if (user) {
                    userId = user.uid;
                    document.getElementById('user-id').textContent = userId;
                    const isAdmin = await checkAdminStatus(userId);
                    if (isAdmin) {
                        adminPanel.classList.remove('hidden');
                        setupRealtimeListeners();
                        setupEventListeners();
                    } else {
                        notAuthorizedPanel.classList.remove('hidden');
                    }
                } else {
                    notAuthorizedPanel.classList.remove('hidden');
                }
            });
        });

        async function checkAdminStatus(uid) {
            const adminDocRef = window.firebase.doc(db, `/artifacts/${appId}/public/data/admins`, uid);
            const adminDoc = await window.firebase.getDoc(adminDocRef);
            return adminDoc.exists();
        }

        function setupRealtimeListeners() {
            // Listen to Admins
            const adminsCollectionPath = `/artifacts/${appId}/public/data/admins`;
            const adminsList = document.getElementById('admins-list');

            window.firebase.onSnapshot(window.firebase.collection(db, adminsCollectionPath), (snapshot) => {
                adminsList.innerHTML = '';
                if (snapshot.empty) {
                    adminsList.innerHTML = `<li class="text-sm font-semibold" style="color: var(--textoOscuro);">No hay administradores.</li>`;
                } else {
                    snapshot.forEach((doc) => {
                        const adminId = doc.id;
                        const listItem = document.createElement('li');
                        listItem.className = 'bg-white p-3 rounded-md shadow flex justify-between items-center';
                        listItem.style.borderColor = 'var(--sombra)';
                        listItem.innerHTML = `
                            <span class="text-sm font-semibold" style="color: var(--primarioFuerte);">${adminId}</span>
                            <button onclick="deleteAdmin('${adminId}')" class="text-sm font-semibold px-3 py-1 rounded-md transition duration-200" style="background-color: #d9534f; color: white;">Eliminar</button>
                        `;
                        adminsList.appendChild(listItem);
                    });
                }
            }, (error) => {
                console.error("Error listening to Firestore (admins):", error);
                showCustomAlert(`Error al cargar la lista de administradores: ${error.message}`);
            });
            
            // Listen to Institutions
            const institutionsCollectionPath = `/artifacts/${appId}/public/data/instituciones`;
            const institutionsList = document.getElementById('institutions-list');

            window.firebase.onSnapshot(window.firebase.collection(db, institutionsCollectionPath), (snapshot) => {
                institutionsList.innerHTML = '';
                if (snapshot.empty) {
                    institutionsList.innerHTML = `<li class="text-sm font-semibold" style="color: var(--textoOscuro);">No hay instituciones.</li>`;
                } else {
                    snapshot.forEach((doc) => {
                        const institutionId = doc.id;
                        const institutionName = doc.data().name;
                        const listItem = document.createElement('li');
                        listItem.className = 'bg-white p-3 rounded-md shadow flex justify-between items-center';
                        listItem.style.borderColor = 'var(--sombra)';
                        listItem.innerHTML = `
                            <span class="text-sm font-semibold" style="color: var(--primarioFuerte);">${institutionName}</span>
                            <button onclick="deleteInstitution('${institutionId}')" class="text-sm font-semibold px-3 py-1 rounded-md transition duration-200" style="background-color: #d9534f; color: white;">Eliminar</button>
                        `;
                        institutionsList.appendChild(listItem);
                    });
                }
            }, (error) => {
                console.error("Error listening to Firestore (institutions):", error);
                showCustomAlert(`Error al cargar la lista de instituciones: ${error.message}`);
            });
        }

        function setupEventListeners() {
            // Tab functionality
            const tabAdmins = document.getElementById('tab-admins');
            const tabInstitutions = document.getElementById('tab-institutions');
            const contentAdmins = document.getElementById('content-admins');
            const contentInstitutions = document.getElementById('content-institutions');

            tabAdmins.addEventListener('click', () => {
                tabAdmins.style.color = 'var(--primarioFuerte)';
                tabAdmins.style.borderColor = 'var(--primarioFuerte)';
                tabInstitutions.style.color = 'var(--textoOscuro)';
                tabInstitutions.style.borderColor = 'transparent';
                contentAdmins.classList.remove('hidden');
                contentInstitutions.classList.add('hidden');
            });

            tabInstitutions.addEventListener('click', () => {
                tabAdmins.style.color = 'var(--textoOscuro)';
                tabAdmins.style.borderColor = 'transparent';
                tabInstitutions.style.color = 'var(--primarioFuerte)';
                tabInstitutions.style.borderColor = 'var(--primarioFuerte)';
                contentAdmins.classList.add('hidden');
                contentInstitutions.classList.remove('hidden');
            });

            document.getElementById('add-admin-btn').addEventListener('click', addAdmin);
            document.getElementById('add-institution-btn').addEventListener('click', addInstitution);
            document.getElementById('logout-button').addEventListener('click', async () => {
                try {
                    await window.firebase.signOut(auth);
                    window.location.href = "index.html";
                } catch (error) {
                    console.error("Error during logout:", error);
                    showCustomAlert(`Error al cerrar sesión: ${error.message}`);
                }
            });
        }

        async function addAdmin() {
            const adminId = document.getElementById('add-admin-id').value.trim();
            if (!adminId) {
                showCustomAlert("Por favor, ingresa una ID de usuario válida.");
                return;
            }
            try {
                const docRef = window.firebase.doc(db, `/artifacts/${appId}/public/data/admins`, adminId);
                await window.firebase.setDoc(docRef, { uid: adminId });
                document.getElementById('add-admin-id').value = '';
                showCustomAlert("Administrador agregado exitosamente.");
            } catch (error) {
                console.error("Error adding admin:", error);
                showCustomAlert(`Error al agregar el administrador: ${error.message}`);
            }
        }

        async function deleteAdmin(adminId) {
            try {
                if (adminId === userId) {
                    showCustomAlert("No puedes eliminar tu propia cuenta de administrador.");
                    return;
                }
                const docRef = window.firebase.doc(db, `/artifacts/${appId}/public/data/admins`, adminId);
                await window.firebase.deleteDoc(docRef);
                showCustomAlert("Administrador eliminado exitosamente.");
            } catch (error) {
                console.error("Error deleting admin:", error);
                showCustomAlert(`Error al eliminar el administrador: ${error.message}`);
            }
        }
        
        async function addInstitution() {
            const institutionName = document.getElementById('add-institution-name').value.trim();
            if (!institutionName) {
                showCustomAlert("Por favor, ingresa un nombre para la institución.");
                return;
            }
            try {
                const collectionPath = `/artifacts/${appId}/public/data/instituciones`;
                await window.firebase.addDoc(window.firebase.collection(db, collectionPath), { name: institutionName });
                document.getElementById('add-institution-name').value = '';
                showCustomAlert("Institución agregada exitosamente.");
            } catch (error) {
                console.error("Error adding institution:", error);
                showCustomAlert(`Error al agregar la institución: ${error.message}`);
            }
        }

        async function deleteInstitution(institutionId) {
            try {
                const docRef = window.firebase.doc(db, `/artifacts/${appId}/public/data/instituciones`, institutionId);
                await window.firebase.deleteDoc(docRef);
                showCustomAlert("Institución eliminada exitosamente.");
            } catch (error) {
                console.error("Error deleting institution:", error);
                showCustomAlert(`Error al eliminar la institución: ${error.message}`);
            }
        }

        function showCustomAlert(message) {
            const container = document.getElementById('custom-alert-container');
            container.innerHTML = `
                <div class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
                    <div class="bg-white p-6 rounded-lg shadow-lg max-w-sm w-full text-center">
                        <p class="text-gray-700 text-lg font-semibold mb-4 whitespace-pre-wrap">${message}</p>
                        <button onclick="document.getElementById('custom-alert-container').innerHTML = ''" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 transition-colors">Aceptar</button>
                    </div>
                </div>
            `;
        }
    </script>
</body>
</html>
